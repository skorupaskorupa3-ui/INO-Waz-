#include <iostream> // wejscie/wyjscie
#include <conio.h> // obsluga klawiatury
#include <windows.h> // biblioteka systemowa windows
#include <ctime> // do losowania pozycji owocow
#include <string> // obsluga tekstu
#include <fstream> // obsluga plikow

using namespace std; 

// zmienne globalne

bool koniec_gry; // stan gry - true oznacza koniec 
const int szerokosc = 20; // stala szerokosc planszy
const int wysokosc = 20; // stala wysokosc planszy
int x, y, wsp_owocu_X, wsp_owocu_Y, wynik; // wspolrzedne (x,y) owocu oraz wynik uzytkownika
int ogon_X[100], ogon_Y[100]; // tablice ogona
int ogon; // dlugosc ogona

// typ wyliczeniowy dla kierunkow ruchu
enum eDirecton {STOP = 0, LEWO, PRAWO, GORA, DOL}; // kierunki
eDirecton dir; // aktualny kierunek ruchu weza

void ZapiszWynik(int punkty) 
{
    string nick; // wpisanie nicku przez uzytkownika
    system("cls"); // czyszczenie ekranu
    cout << "Koniec gry" << endl;
    cout << "Twoj wynik to: " << punkty << endl; // wyswietlenie zdobytych punktow
    cout << "Podaj swoj NICK: ";
    cin >> nick; // pobranie nicku

    ofstream plik; // polaczenie do pliku
    plik.open("wyniki.txt", ios::app); // dopisanie do pliku
    if (plik.good()) // sprawdzanie pliku
    { 
        plik << nick << " - " << punkty << " pkt" << endl; // zapis wyniku
        cout << "wynik zapisany" << endl;
    }
    else 
    {
        cout << "brak dostepu do pliku" << endl;
    }
    plik.close(); // zamkniecie pliku
}
void PokazHistorie()
{
    ifstream plik; // odczyt z pliku
    plik.open("wyniki.txt"); // otwarcie pliku
    string linia;
    cout << "\n historia wynikow " << endl;
    if (plik.good())
    {
        while (getline(plik, linia)) // czytanie lini 
        {
            cout << linia << endl; // wyswietlanie linii
        }
    }

    else
    {
        cout << "brak historii" << endl;
    }
    plik.close(); // zamkniecie pliku
    cout << "nacisnij dowolny klawisz";
    _getch(); // czekaj na klawisz
}

bool Logowanie()
{
    string hasloPrawidlowe = "tajnehaslo"; // haslo gry
    string hasloWpisane = "";
    char ch;
    system("cls");
    cout << "podaj haslo: ";
    while (true)
    {
        ch = _getch(); // wczytaj klawisz
        if (ch == 13) break; // w przypadku dla entera
        else if (ch == 8) // jesli backspace
        {
            if (hasloWpisane.length() > 0)
            {
                cout << "\b \b"; // usun znak z konsoli
                hasloWpisane.pop_back(); // usun znak ze stringa
            }
        }
        else
        {
            hasloWpisane += ch; // dodaj do hasla
            cout << "*"; // wyswietl gwiazdke
        }
    }
    if (hasloWpisane == hasloPrawidlowe) return true; // logowanie poprawne
    else return false; // bledne haslo
}

void Ustawienia() 
{
    koniec_gry = false; // reset wszystkiego
    dir = STOP; // poczatkowy "kierunek" dla weza
    x = szerokosc / 2; // start x
    y = wysokosc / 2; // start y
    wsp_owocu_X = rand() % szerokosc; // losowanie wspolrzednej x dla owocu
    wsp_owocu_Y = rand() % wysokosc; // losowanie wspolrzednej y dla owocu
    wynik = 0; // wynik startowy rowny zero
    ogon = 0; // startowa dlugosc ogona rowna zero
}

void Ukryj_kursor() 
{
    HANDLE consoleHandle = GetStdHandle(STD_OUTPUT_HANDLE); // uchwyt konsoli
    CONSOLE_CURSOR_INFO info;
    info.dwSize = 100;
    info.bVisible = FALSE; // ukrycie kursora
    SetConsoleCursorInfo(consoleHandle, &info); // zapisz zmiany
}

void Ustaw_kursor(int x, int y) 
{
    COORD coord; // koordynaty
    coord.X = x;
    coord.Y = y;
    SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), coord); // ustaw kursor
}
void plansza()
{
    Ustaw_kursor(0, 0); // rysuj od poczatku
    kolor(7); // kolor bialy
    for (int i = 0; i < szerokosc + 2; i++) cout << "#"; // gorna ramka
    cout << endl;

    for (int i = 0; i < wysokosc; i++) // petla pionowa
    {
        for (int j = 0; j < szerokosc; j++) // petla pozioma
        {
            if (j == 0) { kolor(7); cout << "#"; } // lewa ramka
            if (i == y && j == x)
            {
                kolor(10); cout << (char)219; // rysuj glowe
            }
            else if (i == wsp_owocu_Y && j == wsp_owocu_X)
            {
                kolor(12); cout << (char)254; // rysuj owoc
            }
            else
            {
                bool print = false;
                for (int k = 0; k < ogon; k++) { // szukanie ogona
                    if (ogon_X[k] == j && ogon_Y[k] == i)
                    {
                        kolor(2); cout << (char)177; // rysuj ogon
                        print = true;
                    }
                }
                if (!print) { kolor(8); cout << "."; } // tlo
            }
            if (j == szerokosc - 1) { kolor(7); cout << "#"; } // prawa ramka
        }
        cout << endl;
    }
    kolor(7);
    for (int i = 0; i < szerokosc + 2; i++) cout << "#"; // dolna ramka
    cout << endl;
    kolor(15);
    cout << "Wynik: " << wynik << "    " << endl; // pokaz wynik
}

void sterowanie()
{
    if (_kbhit()) // sprawdzenie, czy klawisz zostal nacisniety (biblioteka conio.h)
    {
        switch (_getch()) // sterowanie waz (awsd)
        {
        case 'a': dir = LEWO; break; // lewo
        case 'd': dir = PRAWO; break; // prawo
        case 'w': dir = GORA; break; // gora
        case 's': dir = DOL; break; // dol
        case 'x': koniec_gry = true; break; // wyjscie z gry za pomoca klawisza x
        }
    }
}


void mechanika_gry() 
{
    int prevX = ogon_X[0]; // stara pozycja x
    int prevY = ogon_Y[0]; // stara pozycja y
    int prev2X, prev2Y;
    ogon_X[0] = x; // glowa do ogona x
    ogon_Y[0] = y; // glowa do ogona y
    for (int i = 1; i < ogon; i++) // przesuniecie ogona
    { 
        prev2X = ogon_X[i];
        prev2Y = ogon_Y[i];
        ogon_X[i] = prevX;
        ogon_Y[i] = prevY;
        prevX = prev2X;
        prevY = prev2Y;
    }
    switch (dir) // ruch glowy
    { 
    case LEWO: x--; break;
    case PRAWO: x++; break;
    case GORA: y--; break;
    case DOL: y++; break;
    default: break;
    }
    if (x >= szerokosc) x = 0; else if (x < 0) x = szerokosc - 1; // sciany x
    if (y >= wysokosc) y = 0; else if (y < 0) y = wysokosc - 1; // sciany y

    for (int i = 0; i < ogon; i++) // sprawdz ogon
        if (ogon_X[i] == x && ogon_Y[i] == y) koniec_gry = true;

    if (x == wsp_owocu_X && y == wsp_owocu_Y) // zjedzenie owocu
    { 
        wynik += 10; // dodaj punkty
        wsp_owocu_X = rand() % szerokosc; // nowy owoc x
        wsp_owocu_Y = rand() % wysokosc; // nowy owoc y
        ogon++; // wydluz ogon
    }
}
